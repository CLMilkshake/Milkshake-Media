<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Milkshake Media</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css?v=2">
</head>
<body>
  <header>
    <a href="app.html"><h2 id="title">Milkshake Media</h2></a>
    <button id="menuBtn" class="menu-btn">â˜°</button>
    <div id="menu" class="menu">
      <nav><a href="app.html"><h3>Home</h3></a></nav>
      <nav><a href="profile.html"><h4>Profile</h4></a></nav>
      <nav><a href="friends.html"><h4>Friends</h4></a></nav>
      <nav><a><h4>Report A Bug</h4></a></nav>
      <nav><div id="adminContainer"></div></nav>
      <div id="notifDropdown" class="notif-dropdown hidden"></div>
    </div>
    
    <nav class="notif-nav">
    <button id="notifBtn" class="notifBtn">ðŸ””</button>
    <span id="notifBadge" class="notif-badge hidden"> O</span>
  </nav>

  </header>

  </header>
  <div class="placeholder" style="display: flex; flex-direction:row; width:100%;">
    <div class="profile-card" id="profileEditor" style="width: 100%;">
        <div id="profileAvatar" class="avatar">Error</div>
        <h3 id="profileUsername" style="padding-bottom: 5%; padding-top:10%;"></h3>
        <p id="profileID" style="padding-bottom: 10%; color:gray;"></p>
        <input type="text" id="editName" placeholder="Real Name">
        <input type="text" id="editAvatar" placeholder="Avatar URL or Emoji">
        <textarea id="editDescription" placeholder="Description"></textarea>
        <button id="saveProfile">Save Changes</button>
        <button id="logout-btn" style="margin-top:15%; background-color:red;">Logout</button>
    </div>
    <div class="settings" id="settingsPanel" style="width: 100%; margin-top:5%;">
        <h2>Settings</h2>
        <div class="settingsOption" style="display: flex; flex-direction:row;">
          <h4>Only Show Friend's Posts?</h4>
          <input type="checkbox" id="friendsOnlyToggle" style="margin-left: 5%; padding:3%;" checked>
        </div>
    </div>
    <div id="profilePosts" class="posts"></div>
  </div>


<script>
  window.addEventListener("DOMContentLoaded", loadProfile);
  const menuBtn = document.getElementById("menuBtn");
  const mainNav = document.getElementById("menu");

  menuBtn.addEventListener("click", () => {
    mainNav.classList.toggle("active");
  });
  const toggle = document.getElementById("friendsOnlyToggle");

// Load saved preference on page load
window.addEventListener("DOMContentLoaded", () => {
    const saved = localStorage.getItem("friendsOnly");
    toggle.checked = saved === "true";  // saved is a string
});

// Save preference when toggled
toggle.addEventListener("change", () => {
    localStorage.setItem("friendsOnly", toggle.checked);
});


async function loadProfile() {
    const params = new URLSearchParams(window.location.search);
    const viewedUser = params.get("username"); // get ?username=

    try {
        // Fetch profile: pass username if viewing another user
        const url = viewedUser 
            ? `https://api.clmilkshake.cc/profile?username=${encodeURIComponent(viewedUser)}`
            : "https://api.clmilkshake.cc/profile";
        const me = "https://api.clmilkshake.cc/profile";

        const res = await fetch(url, { credentials: "include" });

        if (res.status === 401) {
            window.location.href = "index.html";
            return;
        }

        const profile = await res.json();
        const isOwnProfile = !viewedUser || viewedUser === me;
        

        // Update profile info
        document.getElementById("profileUsername").innerText = profile.username;
        document.getElementById("profileAvatar").innerText = profile.avatar || "ðŸ™‚";
        document.getElementById("profileID").innerText = isOwnProfile ? "Profile Code: " + profile.id : "";

        // Show/hide edit fields
        const profileEditor = document.getElementById("profileEditor");
        const settingsPanel = document.getElementById("settingsPanel");
        if (isOwnProfile) {
            profileEditor.querySelector("#editName").value = profile.name || "";
            profileEditor.querySelector("#editAvatar").value = profile.avatar || "";
            profileEditor.querySelector("#editDescription").value = profile.description || "";
            settingsPanel.style.display = "block";
            profileEditor.querySelectorAll("input, textarea, button").forEach(el => el.style.display = "");
        } else {
            settingsPanel.style.display = "none";
            profileEditor.querySelectorAll("input, textarea, button").forEach(el => el.style.display = "none");
            loadUserPosts(viewedUser);  // call here
        }

    } catch (err) {
        console.error(err);
        alert("Failed to load profile.");
    }
}


  async function loadOtherUserProfile(username) {
    const res = await fetch(
      `https://api.clmilkshake.cc/profile/${encodeURIComponent(username)}`,
      { credentials: "include" }
    );

    if (!res.ok) {
      alert("User not found");
      return;
    }

    const profile = await res.json();

    document.getElementById("profileUsername").innerText = profile.username;
    document.getElementById("profileID").innerText = "";
    document.getElementById("profileAvatar").innerText = profile.avatar || "ðŸ™‚";
  }


  async function loadUserPosts(username) {
    try {
        const res = await fetch(`https://api.clmilkshake.cc/posts?username=${encodeURIComponent(username)}`, {
            credentials: "include"
        });

        if (!res.ok) {
            console.error("Failed to load user posts:", res.status);
            return;
        }

        const posts = await res.json();
        const container = document.getElementById("profilePosts");
        container.innerHTML = "";

        if (!posts.length) {
            container.innerHTML = "<p>No posts yet.</p>";
            return;
        }

        posts.forEach(post => {
            const div = document.createElement("div");
            div.className = "post-card";
            div.innerHTML = `
                <div class="post-header">
                    <div class="post-user">
                        <div class="avatar">${post.avatar || "ðŸ™‚"}</div>
                        <span class="real-name">${post.name || ""}</span>
                        <span class="username">(${post.username})</span>
                    </div>
                    <span class="post-time">${post.time}</span>
                </div>
                <div class="post-content">
                    <p>${post.content}</p>
                </div>
            `;
            container.appendChild(div);
        });
    } catch (err) {
        console.error("Error loading user posts:", err);
    }
}

// Save profile changes
document.getElementById("saveProfile").addEventListener("click", async () => {
  const name = document.getElementById("editName").value.trim();
  const avatar = document.getElementById("editAvatar").value.trim();
  const description = document.getElementById("editDescription").value.trim();

  if (!name) {
    alert("Name cannot be empty");
    return;
  }

  try {
    const res = await fetch("https://api.clmilkshake.cc/profile", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, avatar, description})
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(text);
    }

    alert("Profile updated successfully!");
    loadProfile(); // reload to reflect changes

  } catch (err) {
    console.error(err);
    alert("Failed to update profile");
  }
});

// Load profile when page loads
window.addEventListener("DOMContentLoaded", loadProfile);
</script>

 <script>
    // Logout Script
    const logoutButton = document.getElementById('logout-btn');

    logoutButton.addEventListener('click', async () => {
      try {
        await fetch('https://api.clmilkshake.cc/logout', {
          method: 'POST',
          credentials: 'include' // include cookies
        });

        // Redirect to login page after logging out
        window.location.href = 'index.html';
      } catch (err) {
        console.error('Logout failed:', err);
        alert('Logout failed. Try refreshing the page.');
      }
    });
  </script>

<script>
const navContainer = document.getElementById("adminContainer");
  if (navContainer) {
    fetch("https://api.clmilkshake.cc/profile", { credentials: "include" })
      .then(res => res.ok ? res.json() : null)
      .then(user => {
        if (user?.is_admin) {
          const adminNav = document.createElement("nav");
          adminNav.className = "admin-page";
          adminNav.innerHTML = `<a href="admin.html"><h4 style="color: rgb(255,140,140); padding:10px; border-radius:10px;">Admins</h4></a>`;
          navContainer.appendChild(adminNav);
        }
      })
      .catch(err => console.error("Error checking admin status:", err));
  }


</script>

</body>
</html>
