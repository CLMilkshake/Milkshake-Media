<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Milkshake Media</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css?v=2">
</head>
<body>
  <header>
    <a href="app.html"><h2 id="title">Milkshake Media</h2></a>
    <button id="menuBtn" class="menu-btn">â˜°</button>
    <div id="menu" class="menu">
      <nav><a href="app.html"><h3>Home</h3></a></nav>
      <nav><a href="profile.html"><h4>Profile</h4></a></nav>
      <nav><a href="friends.html"><h4>Friends</h4></a></nav>
      <nav><a href="https://forms.gle/1B1fMgvZab4xDPCa9"><h4>Report A Bug</h4></a></nav>
      <div id="adminContainer"></div>
      <div id="notifDropdown" class="notif-dropdown hidden"></div>
    </div>
    
    <nav class="notif-nav">
      <button id="notifBtn" class="notifBtn">ðŸ””</button>
      <span id="notifBadge" class="notif-badge hidden">O</span>
    </nav>
  </header>

  <div class="placeholder" style="display: flex; flex-direction: row; width: 100%;">
    <div class="profile-card" id="profileEditor" style="width: 100%;">
      <div id="profileAvatar" class="avatar">
        <img id="profileAvatarImg" src="" alt="Avatar">
      </div>
      <input type="file" id="avatarInput" accept="image/png,image/jpeg,image/webp" hidden />
      <h3 id="profileUsername" style="padding-bottom: 5%; padding-top:10%;"></h3>
      <p id="profileID" style="padding-bottom: 10%; color:gray;"></p>
      <input type="text" id="editName" placeholder="Real Name">
      <textarea id="editDescription" placeholder="Description"></textarea>
      <button id="friend" onclick="AddFriend()" style="display:none;">Add Friend</button>
      <button id="saveProfile">Save Changes</button>
      <button id="logout-btn" style="margin-top:15%; background-color:red;">Logout</button>
    </div>

    <div class="settings" id="settingsPanel" style="width: 100%; margin-top:5%; display:none; flex-direction:column;">
      <h2>Settings</h2>
      <div class="settingsOption" style="display: flex; flex-direction: row;">
        <button id="installBtn" hidden style="margin: 2%;">Install App</button>
      </div>
      <div class="settingsOption" style="display: flex; flex-direction: row;">
        <!--<h4>Only Show Friend's Posts?</h4>
        <input type="checkbox" id="friendsOnlyToggle" style="margin-left: 5%; padding:3%;" checked>-->
        <button id="enablePush" style="margin: 2%;">Enable Notifications</button>
        <button id="disablePush" style="margin: 2%;">Disable Notifications</button>
      </div>
    </div>

    <div id="profilePosts" class="posts"></div>
  </div>

  <script>
    // Elements
    const profileAvatarImg = document.getElementById("profileAvatarImg");
    const avatarInput = document.getElementById("avatarInput");
    const toggle = document.getElementById("friendsOnlyToggle");
    const profileEditor = document.getElementById("profileEditor");
    const settingsPanel = document.getElementById("settingsPanel");
    const friendButton = document.getElementById("friend");

    // Avatar helper
    function avatarUrl(path) {
      if (!path) return "/media/images/avatars/default-avatar.webp"; // local default
      return "https://api.clmilkshake.cc/" + path.replace("uploads/", "");
    }

    // Enable avatar edit if own profile
    function enableAvatarEdit(isOwnProfile) {
      profileAvatarImg.style.cursor = isOwnProfile ? "pointer" : "default";
      profileAvatarImg.title = isOwnProfile ? "Click to change avatar" : "";
      if (isOwnProfile) {
        profileAvatarImg.addEventListener("click", () => avatarInput.click());
      }
    }

    avatarInput.addEventListener("change", async () => {
      const file = avatarInput.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        alert("Avatar must be under 5MB");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch("https://api.clmilkshake.cc/upload-avatar", {
          method: "POST",
          body: formData,
          credentials: "include"
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Upload failed");
        if (!data.avatar) throw new Error("No avatar returned from server");

        profileAvatarImg.src = avatarUrl(data.avatar) + "?v=" + Date.now();
        alert("Avatar updated successfully!");
      } catch (err) {
        console.error(err);
        alert(err.message);
      }
    });
    async function getMyProfile() {
      const params = new URLSearchParams(window.location.search);
      const viewedUser = params.get("username");
      const res = await fetch(`https://api.clmilkshake.cc/profile?username=${encodeURIComponent(viewedUser)}`, {
        credentials: "include"
      });

      if (!res.ok) return null;

      cachedProfile = await res.json();
      return cachedProfile;
    }

    // Friends-only toggle
    //window.addEventListener("DOMContentLoaded", () => {
    //  const saved = localStorage.getItem("friendsOnly");

    //  if (saved === null) {
    //    localStorage.setItem("friendsOnly", "false");
    //    toggle.checked = false;
    //  } else {
    //    toggle.checked = saved === "true";
    //  }
    //});

    //toggle.addEventListener("change", () => {
    //  localStorage.setItem("friendsOnly", toggle.checked.toString());
    //});


    // Load profile
    async function loadProfile() {
      const params = new URLSearchParams(window.location.search);
      const viewedUser = params.get("username");
      const url = viewedUser 
          ? `https://api.clmilkshake.cc/profile?username=${encodeURIComponent(viewedUser)}`
          : "https://api.clmilkshake.cc/profile";

      try {
        const res = await fetch(url, { credentials: "include" });
        if (res.status === 401) { window.location.href = "index.html"; return; }

        const profile = await res.json();
        const isOwnProfile = !viewedUser;

        enableAvatarEdit(isOwnProfile);

        // Update profile info
        document.getElementById("profileUsername").innerText = profile.username;
        profileAvatarImg.src = profile.avatar ? avatarUrl(profile.avatar) : "https://api.clmilkshake.cc/media/images/avatars/default-avatar.webp";
        document.getElementById("profileID").innerText = isOwnProfile
          ? "Profile Code: " + profile.id
          : profile.description;

        // Show/hide edit fields
        if (isOwnProfile) {

          profileEditor.querySelector("#editName").value = profile.name || "";
          profileEditor.querySelector("#editDescription").value = profile.description || "";
          settingsPanel.style.display = "flex";
          //settingsPanel.style.display = "none";
          profileEditor.querySelectorAll("input, textarea, button").forEach(el => el.style.display = "");
          friendButton.style.display = "none";
        } else {
          settingsPanel.style.display = "none";
          profileEditor.querySelectorAll("input, textarea, button").forEach(el => el.style.display = "none");
          friendButton.style.display = "block";
          loadUserPosts(viewedUser);
        }

      } catch (err) {
        console.error(err);
        alert("Failed to load profile.");
      }
    }

    const avatarCache = {}; // cache so we don't fetch the same user multiple times

  async function getAvatarByUsername(username) {
      if (avatarCache[username]) return avatarCache[username];

      try {
          const res = await fetch(`https://api.clmilkshake.cc/profile?username=${encodeURIComponent(username)}`, {
              credentials: "include"
          });

          if (!res.ok) throw new Error("Failed to fetch profile");

          const profile = await res.json();
          const avatar = profile.avatar ? `https://api.clmilkshake.cc/${profile.avatar.replace("uploads/", "")}` : "https://api.clmilkshake.cc/media/images/avatars/default-avatar.webp";

          avatarCache[username] = avatar; // save in cache
          return avatar;
      } catch (err) {
          console.error("Error fetching avatar for", username, err);
          return "https://api.clmilkshake.cc/media/images/avatars/default-avatar.webp";
      }
  }


    // Load user posts
    async function loadUserPosts(username) {
    try {
        const res = await fetch(`https://api.clmilkshake.cc/posts?username=${encodeURIComponent(username)}`, {
            credentials: "include"
        });

        if (!res.ok) {
            console.error("Failed to load user posts:", res.status);
            return;
        }

        const posts = await res.json();
        const container = document.getElementById("profilePosts");
        container.innerHTML = "";

        if (!posts.length) {
            container.innerHTML = "<p>No posts yet.</p>";
            return;
        }

        for (const post of posts) {
            const avatar = await getAvatarByUsername(post.username); // fetch avatar
            const div = document.createElement("div");
            div.className = "post-card";

            div.innerHTML = `
                <div class="post-header">
                    <div class="post-user">
                        <img class="avatar" src="${avatar}" alt="${post.username}" loading="lazy">
                        <span class="real-name">${post.username}</span>
                    </div>
                    <span class="post-time">${post.time}</span>
                </div>
                <div class="post-content">
                    <p>${post.content}</p>
                </div>
            `;

            container.appendChild(div);
        }
    } catch (err) {
        console.error("Error loading user posts:", err);
    }
}

    // Save profile changes
    document.getElementById("saveProfile").addEventListener("click", async () => {
      const name = document.getElementById("editName").value.trim();
      const description = document.getElementById("editDescription").value.trim();
      if (!name) { alert("Name cannot be empty"); return; }

      try {
        const res = await fetch("https://api.clmilkshake.cc/profile", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, description })
        });
        if (!res.ok) throw new Error(await res.text());

        alert("Profile updated successfully!");
        loadProfile();
      } catch (err) {
        console.error(err);
        alert("Failed to update profile");
      }
    });

    // Logout
    document.getElementById("logout-btn").addEventListener("click", async () => {
      try {
        await fetch('https://api.clmilkshake.cc/logout', { method: 'POST', credentials: 'include' });
        window.location.href = 'index.html';
      } catch (err) {
        console.error('Logout failed:', err);
        alert('Logout failed. Try refreshing the page.');
      }
    });

    // Admin nav
    const navContainer = document.getElementById("adminContainer");
    if (navContainer) {
      fetch("https://api.clmilkshake.cc/profile", { credentials: "include" })
        .then(res => res.ok ? res.json() : null)
        .then(user => {
          if (user?.is_admin) {
            const adminNav = document.createElement("nav");
            adminNav.className = "admin-page";
            adminNav.innerHTML = `<a href="admin.html"><h4 style="color: rgb(255,140,140); padding:10px; border-radius:10px;">Admins</h4></a>`;
            navContainer.appendChild(adminNav);
          }
        }).catch(err => console.error("Error checking admin status:", err));
    }

    // Menu toggle
    const menuBtn = document.getElementById("menuBtn");
    const mainNav = document.getElementById("menu");
    menuBtn.addEventListener("click", () => mainNav.classList.toggle("active"));

    // Load profile on page load
    window.addEventListener("DOMContentLoaded", loadProfile);

  async function AddFriend() {
  const viewedUser = await getViewedProfile();
  if (!viewedUser) {
    alert("No user selected");
    return;
  }

  const code = viewedUser.id; // â† THIS is the fix
  console.log("Adding friend:", code);

  try {
    const res = await fetch("https://api.clmilkshake.cc/friends/add", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code })
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || "Failed to send friend request");
    }

    alert("Sent a friend request!");
  } catch (err) {
    console.error(err);
    alert("An error occurred: " + err.message);
  }
}


let cachedProfile = null;

function getViewedUsername() {
  const params = new URLSearchParams(window.location.search);
  return params.get("username");
}


async function getMyProfile() {
  if (cachedMyProfile) return cachedMyProfile;

  const res = await fetch("https://api.clmilkshake.cc/profile", {
    credentials: "include"
  });

  if (!res.ok) return null;

  cachedMyProfile = await res.json();
  return cachedMyProfile;
}

async function getViewedProfile() {
  const username = getViewedUsername();
  if (!username) return null;

  const res = await fetch(
    `https://api.clmilkshake.cc/profile?username=${encodeURIComponent(username)}`,
    { credentials: "include" }
  );

  if (!res.ok) return null;
  return await res.json();
}



  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('/service-worker.js');
        console.log('Service worker registered:', reg);
      } catch (err) {
        console.error('Service worker registration failed:', err);
      }
    });
  }
  document.addEventListener("DOMContentLoaded", () => {


  // ----- Menu toggle -----
  const menuBtn = document.getElementById("menuBtn");
  const mainNav = document.getElementById("menu");
  if (menuBtn && mainNav) {
    menuBtn.addEventListener("click", () => mainNav.classList.toggle("active"));
  }

  // ----- Service worker registration -----
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log("Service worker registered:", reg))
      .catch(err => console.error("Service worker failed:", err));
  }

  // ----- PWA install prompt -----
  let deferredPrompt = null;
  const installBtn = document.getElementById("installBtn");

  window.addEventListener("beforeinstallprompt", e => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.hidden = false;
  });

  installBtn.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const result = await deferredPrompt.userChoice;
    console.log("Install prompt outcome:", result.outcome);
    deferredPrompt = null;
    installBtn.hidden = true;
  });

  // ----- Push notifications -----
  const enablePushBtn = document.getElementById("enablePush");

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
  }

  async function subscribeForPush(username) {
  const permission = await Notification.requestPermission();
  if (permission !== "granted") return;

  const reg = await navigator.serviceWorker.ready;

  // Fetch VAPID key from backend
  const response = await fetch('https://api.clmilkshake.cc/push/getKey');
  const vapidPublicKey = await response.text();

  const subscription = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
  });

  // Send subscription to backend with username
  await fetch('https://api.clmilkshake.cc/push/subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({
      username: username,   // <-- add username here
      subscription: subscription
    })
  });

  console.log('Push subscription sent for user:', username);
}


  enablePushBtn.addEventListener("click", async () => {
  try {
    const user = await getMyProfile();
    await subscribeForPush(user.username);
  } catch (err) {
    console.error("Cannot subscribe for push:", err);
  }
});

const disablePushBtn = document.getElementById("disablePush");

disablePushBtn.addEventListener("click", async () => {
  try {
    const reg = await navigator.serviceWorker.ready;
    const subscription = await reg.pushManager.getSubscription();

    if (!subscription) {
      alert("You are not currently subscribed to notifications.");
      return;
    }

    // Unsubscribe from push
    const unsubscribed = await subscription.unsubscribe();
    if (unsubscribed) {
      console.log("Successfully unsubscribed from push notifications.");
    }

    // Notify backend to remove subscription from database
    await fetch('https://api.clmilkshake.cc/push/unsubscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ username: YOUR_USERNAME_HERE }) // replace with actual username
    });

    alert("Notifications have been disabled.");
  } catch (err) {
    console.error("Failed to unsubscribe:", err);
    alert("Failed to disable notifications.");
  }
});
});
  
  </script>
</body>
</html>
