<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Milkshake Media</title>
  <link rel="stylesheet" href="style.css?v=2">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="/manifest.json">
</head>
<body>
  <header>
    <a href="app.html"><h2 id="title">Milkshake Media</h2></a>
    <button id="menuBtn" class="menu-btn">‚ò∞</button>
    <div id="menu" class="menu">
      <nav><a href="app.html"><h3>Home</h3></a></nav>
      <nav><a href="profile.html"><h4>Profile</h4></a></nav>
      <nav><a href="friends.html"><h4>Friends</h4></a></nav>
      <nav><a href="https://forms.gle/1B1fMgvZab4xDPCa9"><h4>Report A Bug</h4></a></nav>
      <div id="adminContainer"></div>
      <div id="notifDropdown" class="notif-dropdown hidden"></div>
    </div>
    
    <nav class="notif-nav">
    <button id="notifBtn" class="notifBtn">üîî</button>
    <span id="notifBadge" class="notif-badge hidden"> O</span>
  </nav>

  </header>

  <!-- Add Post Modal -->
    <div id="addPostModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Create a Post</h3>
        <textarea id="postContent" placeholder="What's shakin'?" rows="4"></textarea>
        <input type="file" id="postImage" accept="image/*" />
        <button id="submitPost">Post</button>
      </div>
    </div>

    <!-- Add Post Button -->
    <button id="openPostModal" class="add-post-btn">Add Post</button>

  <!-- Posts container -->
  <div class="posts-container" id="posts-container">
    <h1>Recent Posts</h1>
  </div>

  <div id="recommendations" class="recommendations-sidebar" style="margin-top:5%; margin-bottom:5%; background-color:rgba(0,0,0,0.3); padding:7%; border-radius:10px;">
    <h2 style="font-size: 40px;"><b>Recommended Friends</b></h2>
    <hr style="width: 100%; margin-bottom:2%;">
    <div id="recommendations-list"></div>
  </div>

  <h2>Load More Posts?</h2>
  <button id="loadMoreBtn" style="width: 30%; margin-top:1%;">Load More</button>

  <!-- Download card -->
  <div class="card">
    <h2></h2>
    <button id="installBtn" hidden style="margin: 2%;">Install App</button>
    <button id="enablePush" style="margin: 2%;">Enable Notifications</button>
    <button id="disablePush" style="margin: 2%;">Disable Notifications</button>


  </div>


<script>

  let cachedProfile = null;

  async function getMyProfile() {
    if (cachedProfile) return cachedProfile;

    const res = await fetch("https://api.clmilkshake.cc/profile", {
      credentials: "include"
    });

    if (!res.ok) return null;

    cachedProfile = await res.json();
    return cachedProfile;
  }
  const avatarCache = {}; // cache avatars to avoid repeated requests

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('/service-worker.js');
        console.log('Service worker registered:', reg);
      } catch (err) {
        console.error('Service worker registration failed:', err);
      }
    });
  }
  document.addEventListener("DOMContentLoaded", () => {


  // ----- Menu toggle -----
  const menuBtn = document.getElementById("menuBtn");
  const mainNav = document.getElementById("menu");
  if (menuBtn && mainNav) {
    menuBtn.addEventListener("click", () => mainNav.classList.toggle("active"));
  }

  // ----- Service worker registration -----
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log("Service worker registered:", reg))
      .catch(err => console.error("Service worker failed:", err));
  }

  // ----- PWA install prompt -----
  let deferredPrompt = null;
  const installBtn = document.getElementById("installBtn");

  window.addEventListener("beforeinstallprompt", e => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.hidden = false;
  });

  installBtn.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const result = await deferredPrompt.userChoice;
    console.log("Install prompt outcome:", result.outcome);
    deferredPrompt = null;
    installBtn.hidden = true;
  });

  // ----- Push notifications -----
  const enablePushBtn = document.getElementById("enablePush");

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
  }

  async function subscribeForPush(username) {
  const permission = await Notification.requestPermission();
  if (permission !== "granted") return;

  const reg = await navigator.serviceWorker.ready;

  // Fetch VAPID key from backend
  const response = await fetch('https://api.clmilkshake.cc/push/getKey');
  const vapidPublicKey = await response.text();

  const subscription = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
  });

  // Send subscription to backend with username
  await fetch('https://api.clmilkshake.cc/push/subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({
      username: username,   // <-- add username here
      subscription: subscription
    })
  });

  console.log('Push subscription sent for user:', username);
}


  enablePushBtn.addEventListener("click", async () => {
  try {
    const user = await getMyProfile();
    await subscribeForPush(user.username);
  } catch (err) {
    console.error("Cannot subscribe for push:", err);
  }
});

const disablePushBtn = document.getElementById("disablePush");

disablePushBtn.addEventListener("click", async () => {
  try {
    const reg = await navigator.serviceWorker.ready;
    const subscription = await reg.pushManager.getSubscription();

    if (!subscription) {
      alert("You are not currently subscribed to notifications.");
      return;
    }

    // Unsubscribe from push
    const unsubscribed = await subscription.unsubscribe();
    if (unsubscribed) {
      console.log("Successfully unsubscribed from push notifications.");
    }

    // Notify backend to remove subscription from database
    await fetch('https://api.clmilkshake.cc/push/unsubscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ username: YOUR_USERNAME_HERE }) // replace with actual username
    });

    alert("Notifications have been disabled.");
  } catch (err) {
    console.error("Failed to unsubscribe:", err);
    alert("Failed to disable notifications.");
  }
});



  // ----- Notifications dropdown -----
  const notifBtn = document.getElementById("notifBtn");
  const notifDropdown = document.getElementById("notifDropdown");
  const notifBadge = document.getElementById("notifBadge");

  async function loadNotifications() {
    try {
      const res = await fetch("https://api.clmilkshake.cc/notifications", { credentials: "include" });
      if (!res.ok) return;

      const notifs = await res.json();
      notifDropdown.innerHTML = "";

      const unreadCount = notifs.filter(n => !n.is_read).length;
      if (unreadCount > 0) {
        notifBadge.innerText = unreadCount;
        notifBadge.classList.remove("hidden");
      } else {
        notifBadge.classList.add("hidden");
      }

      notifs.forEach(n => {
        const div = document.createElement("div");
        div.className = "notif-item" + (!n.is_read ? " unread" : "");
        div.innerText = `${n.actor}: ${n.type} ‚Ä¢ ${n.time}`;

        div.onclick = async () => {
          if (n.description) {
            window.location.href = `notification.html?post_id=${n.id}`;
          }
          await fetch(`https://api.clmilkshake.cc/notifications/read/${n.id}`, { method: "POST", credentials: "include" });
          loadNotifications();
        };
        notifDropdown.appendChild(div);
      });

    } catch (err) {
      console.error("Failed to load notifications:", err);
    }
  }

  notifBtn?.addEventListener("click", async () => {
    notifDropdown.classList.toggle("hidden");
    await loadNotifications();
  });

  loadNotifications(); // initial load

  document.addEventListener("click", (e) => {
    if (!notifDropdown.classList.contains("hidden") && !notifDropdown.contains(e.target) && e.target !== notifBtn) {
      notifDropdown.classList.add("hidden");
    }
  });

  // ----- Admin nav -----
  const navContainer = document.getElementById("adminContainer");
  if (navContainer) {
    getMyProfile().then(user => {
      if (user?.is_admin) {
          const adminNav = document.createElement("nav");
          adminNav.className = "admin-page";
          adminNav.innerHTML = `<a href="admin.html"><h4 style="color: rgb(255,140,140); padding:10px; border-radius:10px;">Admins</h4></a>`;
          navContainer.appendChild(adminNav);
        }
      })
      .catch(err => console.error("Error checking admin status:", err));
  }
});

let posts = [];          // all posts fetched from server
let displayedCount = 0;  // how many posts are currently shown
const POSTS_PER_PAGE = 20; // posts per "page"
let friendsOnly = false;

async function getAvatarByUsername(username) {
    if (avatarCache[username]) return avatarCache[username];

    try {
        const res = await fetch(`https://api.clmilkshake.cc/profile?username=${encodeURIComponent(username)}`, {
            credentials: 'include'
        });
        if (!res.ok) throw new Error("Failed to fetch profile");

        const profile = await res.json();
        const avatar = profile.avatar 
            ? `https://api.clmilkshake.cc/${profile.avatar}` 
            : "https://api.clmilkshake.cc/media/images/avatars/default-avatar.webp"; // fallback if no avatar

        avatarCache[username] = avatar;
        return avatar;
    } catch (err) {
        console.error("Error fetching avatar for", username, err);
        return "https://api.clmilkshake.cc/media/images/avatars/default-avatar.webp"; // fallback
    }
}

async function loadRecommendations() {
  try {
    const res = await fetch('https://api.clmilkshake.cc/recommendations', {
      credentials: 'include'
    });
    if (!res.ok) throw new Error("Failed to fetch recommendations");

    const recommendations = await res.json();
    const list = document.getElementById('recommendations-list');
    list.innerHTML = "";

    for (const user of recommendations) {
      const div = document.createElement('div');
      div.className = 'recommendation-item';

      // üî• await the avatar
      const avatar = await getAvatarByUsername(user.username);

      div.innerHTML = `
        <a href="profile.html?username=${encodeURIComponent(user.username)}">
          <img src="${avatar}" alt="${user.username}" class="r-avatar">
          <h4>${user.name || user.username}</h4>
        </a>
      `;

      list.appendChild(div);
    }
  } catch (err) {
    console.error("Error loading recommendations:", err);
    document.getElementById('recommendations-list').innerHTML =
      "<p style='color:#f87171;'>Failed to load recommendations.</p>";
  }
}

// Load saved preference
window.addEventListener("DOMContentLoaded", () => {
    loadRecommendations();
    const saved = localStorage.getItem("friendsOnly");
    friendsOnly = saved === "true";
    fetchPosts(); // load posts with pagination
});

async function fetchPosts() {
    try {
        const [postsRes, friendsRes] = await Promise.all([
            fetch('https://api.clmilkshake.cc/posts', { credentials: 'include' }),
            friendsOnly ? fetch('https://api.clmilkshake.cc/friends', { credentials: 'include' }) : Promise.resolve({ ok: true, json: async () => [] })
        ]);

        if (!postsRes.ok || (friendsOnly && !friendsRes.ok)) throw new Error('Failed to fetch posts or friends');

        posts = await postsRes.json();
        const friends = friendsOnly ? await friendsRes.json() : [];

        const user = await getMyProfile();
        const me = user?.username;

        // Apply flagged + friends filter upfront
        posts = posts.filter(post => post.flagged != true && post.flagged != "True");
        if (friendsOnly) {
            posts = posts.filter(post => post.username === me || friends.includes(post.username));
        }

        displayedCount = 0;
        const container = document.getElementById('posts-container');
        container.innerHTML = "<h1>Recent Posts</h1>"; // clear old posts
        renderPosts(); // render first page

    } catch (err) {
        console.error(err);
        document.getElementById('posts-container').innerHTML = '<p style="text-align:center;color:#f87171;">Failed to load posts.</p>';
    }
}

function renderMentions(text) {
  return text.replace(
    /@([a-zA-Z0-9_]+)/g,
    `<b><a href="/profile.html?username=$1" class="mention">@$1</a></b>`
  );
}


async function renderPosts() {

    const container = document.getElementById('posts-container');
    const nextPosts = posts.slice(displayedCount, displayedCount + POSTS_PER_PAGE);

    for (const post of nextPosts) {
        // Fetch avatar for this post
        const avatar = "https://api.clmilkshake.cc" + post.avatar;

        const postCard = document.createElement('div');
        postCard.className = 'post-card';
        postCard.innerHTML = `
            <div class="post-header">
                <div class="post-user">
                    <img class="avatar" src="${avatar}" alt="${post.username}">
                    <a href="profile.html?username=${encodeURIComponent(post.username)}" class="real-name" style="text-decoration:underline; color:white;">${post.name || ''}</a>
                    <span class="username">(${post.username})</span>
                </div>
                <span class="post-time">${post.time}</span>
            </div>
            <div class="post-content">
                <p>${renderMentions(post.content)}</p>
                ${post.images && post.images.length ? `
                  <div class="post-images">
                    ${post.images.map(img =>
                      `<img src="https://api.clmilkshake.cc${img}" class="post-image" loading="lazy">`
                    ).join("")}
                  </div>
                ` : ""}

            </div>
            <div class="post-actions">
                <span class="like-count">${post.like_count || 0}</span>
                <button class="like-btn ${post.isLiked ? 'liked' : ''}" style="${post.isMine ? 'display:none;' : 'display:block;'} background:#251833;">Like</button>
                


                ${post.isMine ? `<button class="delete-btn" data-id="${post.id}" style="background:rgb(105, 38, 64);">üóëÔ∏è</button>` : ""}
            </div>
        `;
          
        //  Comment / Share buttons that need to be put in the gap above when they're added
        //  <button class="comment-btn" style="background:#332f18">Comment</button>
        //  <button class="share-btn" style="background:#183133;">Share</button>
        container.appendChild(postCard);

        // ----- Like button logic -----
        const likeBtn = postCard.querySelector('.like-btn');
        const likeCountEl = postCard.querySelector('.like-count');

        likeBtn.addEventListener('click', async () => {
            likeBtn.disabled = true;
            const liked = likeBtn.classList.contains('liked');
            let currentLikes = parseInt(likeCountEl.innerText);

            // Optimistic UI update
            if (liked) {
                likeCountEl.innerText = currentLikes - 1;
                likeBtn.classList.remove('liked');
            } else {
                likeCountEl.innerText = currentLikes + 1;
                likeBtn.classList.add('liked');
            }

            try {
                const res = await fetch(`https://api.clmilkshake.cc/posts/${post.id}/like`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: liked ? 'unlike' : 'like' })
                });
                if (!res.ok) throw new Error('Failed to like/unlike post');
                post.like_count = liked ? currentLikes - 1 : currentLikes + 1;
                post.isLiked = !liked;
            } catch (err) {
                console.error(err);
                likeCountEl.innerText = currentLikes;
                if (liked) likeBtn.classList.add('liked');
                else likeBtn.classList.remove('liked');
                alert("Failed to like/unlike the post.");
            } finally {
                likeBtn.disabled = false;
            }
        });
    }

    displayedCount += nextPosts.length;

    const loadMoreBtn = document.getElementById("loadMoreBtn");
    loadMoreBtn.style.display = displayedCount >= posts.length ? "none" : "block";
}

    const container = document.getElementById('posts-container');

    container.addEventListener('click', async (e) => {
        if (!e.target.classList.contains('delete-btn')) return;

        const postId = e.target.dataset.id;
        if (!confirm("Are you sure you want to delete this post?")) return;

        try {
            const res = await fetch(`https://api.clmilkshake.cc/posts/${postId}`, {
                method: "DELETE",
                credentials: "include"
            });
            if (!res.ok) throw new Error(`Failed to delete post: ${res.status}`);

            // Remove post from array
            posts = posts.filter(p => p.id != postId);

            // Remove post element from DOM
            e.target.closest('.post-card').remove();

            // Adjust displayedCount if needed
            displayedCount = Math.min(displayedCount, posts.length);

            // Hide load more if necessary
            //loadMoreBtn.style.display = displayedCount >= posts.length ? "none" : "block";

        } catch (err) {
            console.error(err);
            alert(`Failed to delete post ${err}`);
        }
    });


    

  // ----- Like button click -----
      const likeBtn = postCard.querySelector('.like-btn');
      const likeCountEl = postCard.querySelector('.like-count');

      likeBtn.addEventListener('click', async () => {
          // Disable button immediately
          likeBtn.disabled = true;

          // Optimistically update UI
          const currentLikes = parseInt(likeCountEl.innerText);
          likeCountEl.innerText = currentLikes + 1;

          try {
              const res = await fetch(`https://api.clmilkshake.cc/posts/${post.id}/like`, {
                  method: 'POST',
                  credentials: 'include'
              });

              if (!res.ok) {
                  throw new Error('Failed to like post');
              }
          } catch (err) {
              console.error(err);
              // Revert UI if failed
              likeCountEl.innerText = currentLikes;
              likeBtn.disabled = false;
              alert("Failed to like the post. Try again.");
          }
      });


    displayedCount += nextPosts.length;

    const loadMoreBtn = document.getElementById("loadMoreBtn");

    
    // Load more button
    loadMoreBtn.addEventListener("click", renderPosts);

// Load more button click
document.getElementById("loadMoreBtn").addEventListener("click", renderPosts);
</script>



  <script>
    const modal = document.getElementById("addPostModal");
    const openBtn = document.getElementById("openPostModal");
    const closeBtn = modal.querySelector(".close");
    const submitBtn = document.getElementById("submitPost");

    // Open modal
    openBtn.addEventListener("click", () => {
      modal.style.display = "block";
    });

    // Close modal
    closeBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    // Close modal if click outside content
    window.addEventListener("click", (e) => {
      if (e.target == modal) {
        modal.style.display = "none";
      }
    });

    // Submit post
    submitBtn.addEventListener("click", async () => {
      const content = document.getElementById("postContent").value.trim();
      const imageFile = document.getElementById("postImage").files[0]; // get selected file

      if (!content && !imageFile) {
        alert("Post cannot be empty");
        return;
      }

      try {
        // Use FormData to handle both text and file
        const formData = new FormData();
        formData.append("content", content);
        if (imageFile) formData.append("image", imageFile);

        const res = await fetch("https://api.clmilkshake.cc/posts", {
          method: "POST",
          credentials: "include",
          body: formData // DO NOT set Content-Type, browser handles it
        });

        if (!res.ok) throw new Error(`Failed to post: ${res.status}`);

        // Reset modal
        document.getElementById("postContent").value = "";
        document.getElementById("postImage").value = "";
        modal.style.display = "none";

        fetchPosts(); // reload posts

      } catch (err) {
        console.error(err);
        alert("Failed to submit post. You might need to login again.");
      }
    });


  </script>


 

    
  <!-- <script> (https version)
    const logoutButton = document.getElementById('logout-btn');

    logoutButton.addEventListener('click', () => {
      // Delete all cookies
      document.cookie.split(";").forEach(cookie => {
        const eqPos = cookie.indexOf("=");
        const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
      });

      // Optional: reload page or redirect to login
      window.location.href = "index.html"; // redirect to login page
    });
</script> -->


</body>
</html>
